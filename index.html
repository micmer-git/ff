<!DOCTYPE html>
<html lang="it" id="roothtml">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>futuro fortissimo â€“ explorer</title>

  <!-- Google Sans -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Tailwind (CDN build) -->
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['"Google Sans"', 'Roboto', 'ui-sans-serif'] },
          colors:     { ioBg:  '#F6F9FE' },
          boxShadow:  { neu:   '4px 4px 8px rgba(0,0,0,.06)' }
        }
      }
    };
  </script>

  <style>
    body{background:#F6F9FE}
    mark{background:#FFEB3B66;padding:0 2px;border-radius:3px}
    .pill,.tag{background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.1);padding:4px 12px;border-radius:9999px;user-select:none;transition:.15s}
    .pill{cursor:pointer;font-size:1.1rem}.pill.active{outline:2px solid #38bdf8}
    .hide-scrollbar::-webkit-scrollbar{display:none}
    .hide-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
    .scroll-snap-x{scroll-snap-type:x mandatory}
    .snap-start{scroll-snap-align:start}
    /* card open / close animation */
    .exp-card{transform:scale(.95);opacity:0;transition:transform .35s ease,opacity .35s ease}
    .exp-card.enter{transform:scale(1);opacity:1}
    .exp-card.exit{transform:scale(.9);opacity:0}
    .expander{position:absolute;right:10px;bottom:10px;background:#ffffff;border-radius:9999px;padding:6px 9px;font-size:18px;box-shadow:0 1px 4px rgba(0,0,0,.15);cursor:pointer}
    /* smaller fonts for books and notes */
    .book-quote{font-size:0.95rem}
    .book-title{font-size:0.8rem}
    .book-page{font-size:0.7rem}
    .note-title{font-size:0.95rem}
    .note-desc{font-size:0.8rem}
  </style>
</head>

<body class="font-sans text-gray-800 antialiased text-[18px]">
<header class="py-2">
  <div class="max-w-3xl mx-auto flex items-center justify-center gap-3 px-4">
    <img src="logo.png" alt="logo Futuro Fortissimo" class="h-8" />
    <h1 class="italic lowercase text-3xl font-semibold">futuro fortissimo</h1>
  </div>
</header>

<section class="max-w-3xl mx-auto px-4 space-y-3">
  <div class="relative">
    <input id="searchInput" placeholder="search / cercaâ€¦" class="w-full rounded-full py-2 pl-11 pr-4 bg-white shadow-neu focus:outline-none focus:ring-2 focus:ring-sky-400" />
    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-lg">ğŸ”</span>
  </div>

  <div id="filterRow" class="flex flex-wrap justify-center gap-2 text-xl">
    <span class="pill" data-filter="ğŸ’»">ğŸ’»</span><span class="pill" data-filter="ğŸƒ">ğŸƒ</span><span class="pill" data-filter="â¤ï¸">â¤ï¸</span>
    <span class="pill" data-filter="ğŸ’¸">ğŸ’¸</span><span class="pill" data-filter="âš½">âš½</span><span class="pill" data-filter="ğŸ½">ğŸ½</span>
    <span class="pill" data-filter="ğŸ§ ">ğŸ§ </span><span class="pill" data-filter="ğŸ’Š">ğŸ’Š</span><span class="pill" data-filter="ğŸ¨">ğŸ¨</span>
    <span class="pill" data-filter="ğŸš•">ğŸš•</span><span class="pill" data-filter="ğŸ¥½">ğŸ¥½</span><span class="pill" data-filter="ğŸ‘¥">ğŸ‘¥</span><span class="pill" data-filter="ğŸ’†">ğŸ’†</span>
  </div>
</section>

<main id="app" class="max-w-3xl mx-auto px-4 pb-32 space-y-6 mt-6"></main>

<footer class="fixed bottom-0 inset-x-0 flex items-center justify-center gap-3 py-2 text-base bg-ioBg/90 backdrop-blur">
  <button onclick="window.open('https://www.paypal.com/paypalme/michelemerelli','_blank')" class="pill">â˜• sostieni</button>
  <button onclick="window.open('https://linktr.ee/micmer','_blank')" class="pill">ğŸ‘¤ chi&nbsp;sono</button>
  <button id="langToggle" class="pill">ğŸ‡¬ğŸ‡§ english</button>
</footer>

<script>
/* ------------------- paths & globals ------------------- */
let LANG='it';
const PATH = { it:'newsletter_data.json', en:'newsletter_data_en.json' };
const NOTES_PATH='notes.json';
const BOOKS_PATH='books.json';

let DATA, NOTES, BOOKS;
const filters=new Set();
const gradients=[
  'linear-gradient(135deg,#38bdf8,#c084fc)','linear-gradient(135deg,#f472b6,#facc15)',
  'linear-gradient(135deg,#34d399,#60a5fa)','linear-gradient(135deg,#f87171,#fb923c)',
  'linear-gradient(135deg,#a78bfa,#f472b6)','linear-gradient(135deg,#fb923c,#fde68a)',
  'linear-gradient(135deg,#5eead4,#3b82f6)','linear-gradient(135deg,#fda4af,#c4b5fd)'
];

/* ------------------- helpers ------------------- */
const match=(txt,term)=>txt.toLowerCase().includes(term);
const hl=(txt,term)=>term?txt.replace(new RegExp(`(${term})`,'gi'),'<mark>$1</mark>'):txt;
const $ = s => document.querySelector(s);

/* ------------------- listeners ------------------- */
$('#filterRow').addEventListener('click',e=>{
  if(!e.target.dataset.filter) return;
  const v=e.target.dataset.filter;
  e.target.classList.toggle('active');
  filters.has(v) ? filters.delete(v) : filters.add(v);
  render();
});
$('#searchInput').oninput=render;

$('#langToggle').onclick=()=>{
  LANG = LANG==='it' ? 'en' : 'it';
  $('#langToggle').textContent = LANG==='it' ? 'ğŸ‡¬ğŸ‡§ english' : 'ğŸ‡®ğŸ‡¹ italiano';
  document.documentElement.lang = LANG;
  loadAll();
};

/* ------------------- load JSON ------------------- */
async function loadAll(){
  [DATA,NOTES,BOOKS] = await Promise.all([
    fetch(PATH[LANG]).then(r=>r.json()),
    fetch(NOTES_PATH).then(r=>r.json()),
    fetch(BOOKS_PATH).then(r=>r.json()).catch(()=>({books:[]}))]);

  DATA.publications.sort(()=>Math.random()-0.5); // random order
  filters.clear();
  document.querySelectorAll('.pill.active').forEach(p=>p.classList.remove('active'));
  $('#searchInput').value='';
  render();
}

/* ------------------- render loop ------------------- */
function render(){
  const term = $('#searchInput').value.toLowerCase();
  const activeS = term.length>0;
  const activeF = filters.size>0;
  const wrap = $('#app');
  wrap.innerHTML='';

  if(!activeS && !activeF) wrap.appendChild(makePubStrip(DATA.publications));

  // First render books section (above notes)
  const bookVis = BOOKS.books.filter(b=>{
    const tagOk=!activeF||b.tags.some(t=>filters.has(t));
    const txtOk=!activeS||match(b.quote,term)||match(b.title,term)||match(b.author,term);
    return tagOk&&txtOk;
  });
  if(bookVis.length) wrap.appendChild(makeBooksStrip(bookVis, term, activeF));

  // Then render notes section
  const noteVis = NOTES.notes.filter(n=>{
    const tagOk=!activeF||n.tags.some(t=>filters.has(t));
    const txtOk=!activeS||match(n.title,term)||match(n.description,term);
    return tagOk&&txtOk;
  });
  if(noteVis.length) wrap.appendChild(makeNotesStrip(noteVis, term, activeF));

  // Finally render publications
  DATA.publications.forEach((pub,idx)=>{
    if(activeS||activeF){
      const vis = pub.cards
        .filter(sc=>!sc.title.startsWith('ğŸ“–'))
        .filter(sc=>{
          const tagOk = !activeF || sc.tags?.some(t=>filters.has(t));
          const txtOk = !activeS || match(sc.title,term) || sc.contentBlocks.some(b=>b.content.some(l=>match(l,term)));
          return tagOk && txtOk;
        });
      if(!vis.length) return;
      wrap.appendChild(makePubCard(pub,vis,idx,true,term,activeF));
    }
  });
}

/* ------------------- components ------------------- */
function makePubStrip(list){
  const strip=document.createElement('div');
  strip.id='pubStrip';
  strip.className='flex gap-4 overflow-x-auto hide-scrollbar scroll-snap-x scroll-smooth pb-2';

  list.forEach((pub,i)=>{
    const card=document.createElement('div');
    card.className='relative rounded-xl flex-shrink-0 snap-start overflow-hidden cursor-pointer w-full max-w-[320px]';
    card.style.background=gradients[i%gradients.length];
    card.style.padding='2px';

    const inner=document.createElement('div');
    inner.className='bg-white rounded-xl p-5 shadow-neu h-40 flex flex-col justify-center';
    const pano=pub.cards.find(c=>c.title.startsWith('ğŸ“–'));
    inner.innerHTML=`<h3 class='font-semibold text-xl mb-2 text-center break-words'>${pub.title}</h3>`+
                    (pano?`<p class='text-base text-center break-words'>${pano.contentBlocks[0].content[0]}</p>`:'');
    card.appendChild(inner);

    const btn=document.createElement('button');
    btn.className='expander'; btn.textContent='â¤¢';
    btn.onclick=e=>{e.stopPropagation();openExpanded(pub);};
    card.appendChild(btn);

    card.onclick=()=>openExpanded(pub);
    strip.appendChild(card);
  });
  return strip;
}

function openExpanded(pub){
  $('#pubStrip')?.classList.add('hidden');
  const wrap=$('#app');
  const idx=DATA.publications.findIndex(p=>p.title===pub.title);
  const scList=pub.cards.filter(sc=>!sc.title.startsWith('ğŸ“–'));
  const card=makePubCard(pub,scList,idx,true,'',false);
  card.classList.add('exp-card');
  wrap.prepend(card);
  requestAnimationFrame(()=>card.classList.add('enter'));

  const close=document.createElement('button');
  close.textContent='âœ•';
  close.className='absolute top-2 right-2 text-2xl';
  close.onclick=()=>{card.classList.remove('enter');card.classList.add('exit');setTimeout(()=>{card.remove();$('#pubStrip')?.classList.remove('hidden');},350);};
  card.style.position='relative';
  card.appendChild(close);
  card.scrollIntoView({behavior:'smooth'});
}

function makePubCard(pub,scList,idx,condensed,term,showTags){
  const card=document.createElement('div');
  card.className='rounded-xl overflow-hidden mb-4';
  card.style.cssText=`background:${gradients[idx%gradients.length]};padding:2px`;

  const inner=document.createElement('div');
  inner.className='bg-white rounded-xl p-5 shadow-neu';
  card.appendChild(inner);

  scList.forEach((sc,i)=>{
    inner.innerHTML+=`
      <div>
        <h3 class='font-semibold mb-1'>${condensed?hl(sc.title,term):sc.title}</h3>
        ${sc.contentBlocks[0].content.map(l=>`<p class='text-base'>${condensed?hl(l,term):l}</p>`).join('')}
        ${showTags?`<div class='flex flex-wrap gap-1 mt-1'>${sc.tags.map(t=>`<span class='tag'>${t}</span>`).join('')}</div>`:''}
      </div>
      ${i<scList.length-1?"<hr class='border-t my-3' />":''}`;
  });
  inner.onclick=()=>window.open(pub.substackLink,'_blank');
  return card;
}

function makeBooksStrip(books, term, showTags){
  const strip=document.createElement('div');
  strip.className='mb-6';
  
  const header=document.createElement('h2');
  header.className='font-semibold text-xl mb-3';
  header.textContent='Libri / Books';
  strip.appendChild(header);
  
  const scrollContainer=document.createElement('div');
  scrollContainer.className='flex gap-4 overflow-x-auto hide-scrollbar scroll-snap-x scroll-smooth pb-2';
  strip.appendChild(scrollContainer);

  books.forEach(b=>{
    const card=document.createElement('div');
    card.className='rounded-xl border-2 border-indigo-500 flex-shrink-0 w-full max-w-[320px] snap-start overflow-hidden';
    card.style.background='#ffffff';
    card.onclick=()=>window.open(b.url,'_blank');

    const inner=document.createElement('div');
    inner.className='p-5 flex flex-col justify-between min-h-[180px]';
    inner.innerHTML=`
      <p class='book-quote font-semibold break-words'>&ldquo;${hl(b.quote, term)}&rdquo;</p>
      <div class='mt-2'>
        <p class='book-title text-gray-600'>${hl(b.title, term)}</p>
        <p class='book-page text-gray-500'>p.&nbsp;${b.page}</p>
      </div>
      ${showTags?`<div class='flex flex-wrap gap-1 mt-2'>${b.tags.map(t=>`<span class='tag text-lg'>${t}</span>`).join('')}</div>`:''}`;
    card.appendChild(inner);
    scrollContainer.appendChild(card);
  });
  return strip;
}

function makeNotesStrip(notes, term, showTags){
  const strip=document.createElement('div');
  strip.className='mb-6';
  
  const header=document.createElement('h2');
  header.className='font-semibold text-xl mb-3';
  header.textContent='Note / Notes';
  strip.appendChild(header);
  
  const scrollContainer=document.createElement('div');
  scrollContainer.className='flex gap-4 overflow-x-auto hide-scrollbar scroll-snap-x scroll-smooth pb-2';
  strip.appendChild(scrollContainer);
  
  notes.forEach(n=>{
    const card=document.createElement('div');
    card.className='rounded-xl border-2 border-black flex-shrink-0 w-full max-w-[320px] snap-start overflow-hidden';
    card.style.background='#ffffff';
    card.onclick=()=>window.open(n.url,'_blank');

    const inner=document.createElement('div');
    inner.className='p-5 flex flex-col justify-between min-h-[160px]';

    const host=(()=>{try{return new URL(n.url).hostname.replace(/^www\\./,'');}catch{return'';}})();
    const tagsHTML=n.tags.map(t=>`<span class='tag text-lg'>${t}</span>`).join('');
    const hostHTML=host?`<span class='tag text-xs'>${host}</span>`:'';

    inner.innerHTML=`
      <h3 class='note-title font-semibold mb-1 break-words'>${hl(n.title, term)}</h3>
      <p class='note-desc text-gray-600'>${hl(n.description, term)}</p>
      <div class='flex flex-wrap items-center gap-1 mt-3'>${showTags?tagsHTML:''}${hostHTML}</div>`;
    card.appendChild(inner);
    scrollContainer.appendChild(card);
  });
  return strip;
}

/* ------------------- start ------------------- */
loadAll();
</script>
</body>
</html>
