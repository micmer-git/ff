<!DOCTYPE html>
<html lang="it" id="root">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>futuro fortissimo ‚Äì explorer</title>

  <!-- Fonts & Tailwind -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Playfair+Display:ital@700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui']
          },
          colors: {
            bg: '#f6f9fe',
            acc: '#38bdf8'
          }
        }
      }
    }
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent }
    body { font-family: Inter, sans-serif; background: var(--tw-bg-opacity) bg; color: #111; overflow: hidden }
    mark { background: #38bdf8; color: #fff; padding: 0 3px; border-radius: 3px }
    .pill, .tag { background: #fff; padding: 4px 13px; border-radius: 9999px; cursor: pointer; user-select: none; transition: .2s }
    .pill { font-size: 1.2rem }
    .pill.active { outline: 2px solid #38bdf8 }
    .tag { font-size: .85rem; margin-top: 4px; margin-right: 4px }
    #canvas { scroll-snap-type: y mandatory; overflow-y: auto; -webkit-overflow-scrolling: touch }
    .page { min-height: calc(100vh - 120px); scroll-snap-align: start; display: flex; align-items: center; padding-left: 6vw }
    .box { width: calc(100% - 12vw); max-width: 720px; max-height: 78vh; overflow-y: auto; padding: 2rem 1.7rem }
    .box::-webkit-scrollbar { display: none }
    .box h3 { font-size: 1.35rem; font-weight: 700; margin-bottom: .4rem }
    .box p { font-size: 1.15rem; line-height: 1.6; margin-bottom: .65rem }
    .box.book h3 { font-size: 1.15rem }
    .src { font-size: .8rem; color: #555; margin-top: .3rem }
  </style>
</head>

<body>
  <!-- HEADER -->
  <header class="fixed inset-x-0 top-0 h-[60px] px-[6vw] flex items-center justify-between z-30">
    <div class="flex items-center gap-2">
      <img src="logo.png" class="h-8">
      <h1 class="font-[Playfair_Display] italic text-[1.55rem]">futuro&nbsp;fortissimo</h1>
    </div>
    <div id="cta" class="flex items-center gap-4 text-[2rem]">
      <span id="ctaCoffee">‚òï</span><span id="ctaAbout">üë§</span>
      <span id="langBtn" class="cursor-pointer">üá¨üáß</span>
    </div>
  </header>

  <!-- SIDE EMOJI BAR -->
  <aside id="side" class="fixed top-[60px] bottom-[60px] right-0 w-[46px] flex flex-col items-center gap-2 pt-3 overflow-y-auto">
  </aside>

  <!-- CANVAS -->
  <main id="canvas" class="fixed top-[60px] bottom-[60px] right-[46px] left-0"></main>

  <!-- SEARCH -->
  <footer class="fixed inset-x-0 bottom-0 h-[60px] bg-bg flex items-center px-[6vw] gap-3">
    <input id="search" placeholder="cerca / search‚Ä¶" class="flex-1 rounded-full border-2 border-black px-4 py-2 text-lg outline-none">
    <button id="searchBtn" class="text-[1.8rem] text-acc">üîç</button>
  </footer>

  <script>
    /* -------- data paths -------- */
    const PATH = { it: 'newsletter_data.json', en: 'newsletter_data_en.json' },
          NOTES = 'notes.json', BOOKS = 'books.json';

    /* -------- state -------- */
    let PUBS, NOTESARR, BOOKSARR, LANG = 'it', q = '';
    const selTags = new Set();
    const gradients = [
      'linear-gradient(135deg,#38bdf8,#c084fc)',
      'linear-gradient(135deg,#f472b6,#facc15)',
      'linear-gradient(135deg,#34d399,#60a5fa)',
      'linear-gradient(135deg,#f87171,#fb923c)',
      'linear-gradient(135deg,#a78bfa,#f472b6)',
      'linear-gradient(135deg,#fb923c,#fde68a)',
      'linear-gradient(135deg,#5eead4,#3b82f6)',
      'linear-gradient(135deg,#fda4af,#c4b5fd)'
    ];
    const allTags = ['üìö','üé∂','üíª','üçÉ','‚ù§Ô∏è','üí∏','‚öΩ','üçΩ','üß†','üíä','üé®','üöï','ü•Ω','üë•','üíÜ'];

    /* -------- helpers -------- */
    const $ = s => document.querySelector(s),
          rnd = a => a.sort(() => Math.random() - .5),
          match = (t) => t.includes(q),
          mark = (t) => q ? t.replace(new RegExp(`(${q})`, 'gi'), '<mark>$1</mark>') : t,
          pg = (c) => { const p = document.createElement('section'); p.className = 'page'; p.appendChild(c); return p; },
          openNew = u => window.open(u, '_blank');

    /* -------- build side tags -------- */
    const side = $('#side');
    allTags.forEach(t => {
      const el = document.createElement('div');
      el.textContent = t;
      el.className = 'pill';
      el.onclick = () => {
        el.classList.toggle('active');
        if (selTags.has(t)) selTags.delete(t);
        else selTags.add(t);
        render();
      };
      side.appendChild(el);
    });

    /* -------- CTA & lang -------- */
    $('#ctaCoffee').onclick = () => openNew('https://www.paypal.com/paypalme/michelemerelli');
    $('#ctaAbout').onclick = () => openNew('https://linktr.ee/micmer');
    $('#langBtn').onclick = () => {
      LANG = LANG === 'it' ? 'en' : 'it';
      $('#langBtn').textContent = LANG === 'it' ? 'üá¨üáß' : 'üáÆüáπ';
      loadData();
    };

    /* -------- search -------- */
    const sInp = $('#search');
    sInp.oninput = () => { q = sInp.value.trim().toLowerCase(); render(); };
    $('#searchBtn').onclick = () => {
      sInp.blur();
      q = sInp.value.trim().toLowerCase();
      render();
    };

    /* -------- load data -------- */
    function loadData() {
      Promise.all([
        fetch(PATH[LANG]).then(r => r.json()),
        fetch(NOTES).then(r => r.json()),
        fetch(BOOKS).then(r => r.json())
      ]).then(([d, n, b]) => {
        PUBS = rnd(d.publications);
        NOTESARR = rnd(n.notes).map(o => ({ ...o, tags: ['üé∂'] }));
        BOOKSARR = rnd(b).map(o => ({ ...o, tags: ['üìö'] }));
        selTags.clear();
        document.querySelectorAll('#side .pill.active').forEach(p => p.classList.remove('active'));
        q = '';
        sInp.value = '';
        render();
      });
    }

    /* -------- factories -------- */
    function pubCard(p, s, hi) {
      const c = document.createElement('div');
      c.className = 'box';
      c.style.background = '#fff';
      c.innerHTML = `<h3>${hi ? mark(s.title) : s.title}</h3>` +
                    s.contentBlocks[0].content.map(l => `<p>${hi ? mark(l) : l}</p>`).join('');
      c.onclick = () => openNew(p.substackLink);
      return pg(c);
    }
    function bookCard(b, hi) {
      const c = document.createElement('div');
      c.className = 'box book';
      c.style.background = '#fff';
      c.innerHTML = `<h3>${hi ? mark(b.title) : b.title}</h3><p>${hi ? mark(b.text) : b.text}</p><p class="src">${b.book} ‚Äî ${b.author}</p>`;
      if (b.url) c.onclick = () => openNew(b.url);
      return pg(c);
    }
    function noteCard(n, hi) {
      const host = n.url ? new URL(n.url).hostname.replace(/^www\./, '') : '';
      const c = document.createElement('div');
      c.className = 'box';
      c.style.background = '#fff';
      c.innerHTML = `<h3>${hi ? mark(n.title) : n.title}</h3>${host ? `<p class="src">${host}</p>` : ''}`;
      if (n.url) c.onclick = () => openNew(n.url);
      return pg(c);
    }

    /* -------- render -------- */
    function render() {
      const cv = $('#canvas');
      cv.innerHTML = '';
      const activeFilter = selTags.size,
            qOn = q.length > 0;
      let stack = [];

      // 1) HOME (nessun filtro e nessuna ricerca) ‚Üí mostro SOLO le note
      if (!activeFilter && !qOn) {
        // carico tutte le note in ordine random
        NOTESARR.forEach(n => {
          stack.push(noteCard(n, false));
        });
      }
      // 2) FILTRO PER TAG (senza ricerca)
      else if (activeFilter && !qOn) {
        if (selTags.size === 1 && selTags.has('üìö')) {
          stack = BOOKSARR.map(b => bookCard(b, false));
        }
        else if (selTags.size === 1 && selTags.has('üé∂')) {
          stack = NOTESARR.map(n => noteCard(n, false));
        }
        else {
          PUBS.forEach(p =>
            p.cards
             .filter(c => !c.title.startsWith('üìñ') && c.tags?.some(t => selTags.has(t)))
             .forEach(c => stack.push(pubCard(p, c, false)))
          );
        }
      }
      // 3) RICERCA (con o senza tag)
      else {
        PUBS.forEach(p =>
          p.cards
           .filter(c => {
             const tagOk = !activeFilter || c.tags?.some(t => selTags.has(t));
             const textOk = match((c.title + c.contentBlocks[0].content.join(' ')).toLowerCase());
             return !c.title.startsWith('üìñ') && tagOk && textOk;
           })
           .forEach(c => stack.push(pubCard(p, c, true)))
        );
        BOOKSARR.forEach(b => {
          if ((!activeFilter || selTags.has('üìö')) && match((b.title + b.text).toLowerCase())) {
            stack.push(bookCard(b, true));
          }
        });
        NOTESARR.forEach(n => {
          if ((!activeFilter || selTags.has('üé∂')) && match(n.title.toLowerCase())) {
            stack.push(noteCard(n, true));
          }
        });
      }

      // mescolo gli elementi prima di aggiungerli al DOM
      rnd(stack).forEach(el => cv.appendChild(el));
      cv.scrollTo(0, 0);
    }

    loadData();
  </script>
</body>
</html>
