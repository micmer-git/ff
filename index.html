<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>futuro fortissimo â€“ explorer</title>

<!-- font & palette -->
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#fafaf7;--fg:#222;--accent:#38bdf8;--pill:#fff;--pill-b:#d1d5db;
  --w:46px;            /* larghezza barra laterale */
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;font-family:"PT Serif",serif;color:var(--fg);background:var(--bg);}
body{display:flex;flex-direction:column}

/* ---------- layout ---------- */
#top{display:flex;align-items:center;gap:.75rem;padding:.5rem 6vw .5rem calc(6vw+var(--w));position:fixed;top:0;left:0;right:0;background:var(--bg);z-index:20}
#top input{flex:1;border:none;border-bottom:1px solid var(--fg);background:transparent;font-size:1rem;outline:none}
.filter-p{border:1px solid var(--pill-b);padding:.15rem .7rem;border-radius:9999px;cursor:pointer;font-size:.9rem}
.filter-p.active{background:var(--accent);border-color:var(--accent);color:#fff}

/* right gutter */
#gutter{position:fixed;right:0;top:0;bottom:0;width:var(--w);display:flex;flex-direction:column;align-items:center;padding-top:4.2rem;gap:.4rem}
.tag{background:var(--pill);border:1px solid var(--pill-b);border-radius:9999px;padding:.1rem .55rem;font-size:.85rem;cursor:pointer}
.tag.active{background:var(--accent);border-color:var(--accent);color:#fff}

/* canvas & pages */
#canvas{height:100%;overflow-y:auto;scroll-snap-type:y mandatory;padding-top:3.5rem}
.page{scroll-snap-align:start;min-height:calc(100vh - 3.5rem);display:flex;align-items:center;justify-content:center;padding:0 6vw calc(3rem);position:relative}
.box{background:#fff;border:1px solid var(--pill-b);border-radius:12px;box-shadow:2px 3px 6px rgba(0,0,0,.05);max-width:680px;width:100%;max-height:68vh;overflow-y:auto;padding:2.2rem}
.box h2{font-size:1.75rem;margin-bottom:1rem;font-weight:700}
.box h3{font-size:1.25rem;margin:.6rem 0 .3rem;font-weight:700}
.box p{line-height:1.55;margin-bottom:.85rem}
.box::-webkit-scrollbar{display:none;}

/* tiny helpers */
.hidden{display:none}
.click{cursor:pointer}
</style>
</head>

<body>

<!-- top-bar -->
<div id="top">
  <input id="searchInput" placeholder="search / cercaâ€¦">
  <div id="filterBooks"  class="filter-p">ðŸ“š</div>
  <div id="filterNotes"  class="filter-p">ðŸŽ¶</div>
</div>

<!-- gutter tag bar -->
<div id="gutter"></div>

<!-- scrolling canvas -->
<div id="canvas"></div>

<script>
/* ---------- sources ---------- */
const SRC={it:'newsletter_data.json',en:'newsletter_data_en.json'};
const NOTES_PATH='notes.json',BOOKS_PATH='books.json';
let LANG='it',PUBS,NOTES,BOOKS;

/* ---------- state ---------- */
const mainFilters=new Set();     // ðŸ“š ðŸŽ¶
const tagFilters =new Set();     // emoji temi
let query='';

/* ---------- helpers ---------- */
const $=s=>document.querySelector(s),
      tagSet=['ðŸ’»','ðŸƒ','â¤ï¸','ðŸ’¸','âš½','ðŸ½','ðŸ§ ','ðŸ’Š','ðŸŽ¨','ðŸš•','ðŸ¥½','ðŸ‘¥','ðŸ’†'],
      match=(t,s)=>t.toLowerCase().includes(s);

/* ---------- build gutter tags ---------- */
const gut=$('#gutter');
tagSet.forEach(e=>{
  const d=document.createElement('div');
  d.textContent=e;d.className='tag';d.dataset.tag=e;
  d.onclick=()=>{d.classList.toggle('active');tagFilters.has(e)?tagFilters.delete(e):tagFilters.add(e);render();}
  gut.appendChild(d);
});

/* ---------- top filters ---------- */
['filterBooks','filterNotes'].forEach(id=>{
  $('#'+id).onclick=ev=>{
    ev.target.classList.toggle('active');
    const k=ev.target.textContent.trim();mainFilters.has(k)?mainFilters.delete(k):mainFilters.add(k);
    render();
  };
});
$('#searchInput').oninput=e=>{query=e.target.value.toLowerCase();render();};

/* ---------- loader ---------- */
Promise.all([
  fetch(SRC[LANG]).then(r=>r.json()),
  fetch(NOTES_PATH).then(r=>r.json()),
  fetch(BOOKS_PATH).then(r=>r.json())
]).then(([d,n,b])=>{
  PUBS =d.publications;
  NOTES=n.notes;
  BOOKS=b;
  shuffle(PUBS);shuffle(NOTES);shuffle(BOOKS);
  render();
});

function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}}

/* ---------- render ---------- */
function render(){
  const C=$('#canvas');C.innerHTML='';
  /* decide what to show */
  let pages=[];

  /* SEARCH mode: include matches from all datasets */
  if(query){
    PUBS.forEach(p=>p.cards.filter(c=>!c.title.startsWith('ðŸ“–')).forEach(c=>{
      const txt=[p.title,c.title,...c.contentBlocks[0].content].join(' ');
      if(match(txt,query)&&(tagsOk(c.tags))) pages.push(buildPubPage(p,c,true));
    }));
    BOOKS.forEach(b=>{if(match(b.title,query)||match(b.text,query)) pages.push(buildBookPage(b,true));});
    NOTES.forEach(n=>{const txt=n.title+(n.description||'');if(match(txt,query)) pages.push(buildNotePage(n,true));});
  }else{
    /* FILTERS */
    if(mainFilters.has('ðŸ“š')&& !mainFilters.has('ðŸŽ¶')){
      BOOKS.forEach(b=>pages.push(buildBookPage(b,false)));
    }else if(mainFilters.has('ðŸŽ¶')&& !mainFilters.has('ðŸ“š')){
      NOTES.forEach(n=>pages.push(buildNotePage(n,false)));
    }else{
      /* default home OR theme filter */
      const hasTheme=tagFilters.size>0;
      PUBS.forEach(p=>{
        p.cards.filter(c=>!c.title.startsWith('ðŸ“–') && (!hasTheme || c.tags?.some(t=>tagFilters.has(t))))
               .forEach(c=>pages.push(buildPubPage(p,c,false)));
      });
      if(!hasTheme){                         /* show books + notes only when no theme filter */
        BOOKS.forEach(b=>pages.push(buildBookPage(b,false)));
        NOTES.forEach(n=>pages.push(buildNotePage(n,false)));
      }
    }
  }
  /* append */
  pages.forEach(p=>C.appendChild(p));
}

/* ---------- page builders ---------- */
function buildPubPage(pub,sub,hl){
  const s=document.createElement('section');s.className='page';
  const box=document.createElement('div');box.className='box click';
  box.innerHTML=`<h2>${hl?mark(pub.title):pub.title}</h2>
                 <h3>${hl?mark(sub.title):sub.title}</h3>
                 ${sub.contentBlocks[0].content.map(t=>`<p>${hl?mark(t):t}</p>`).join('')}`;
  box.onclick=()=>window.open(pub.substackLink,'_blank');
  s.appendChild(box);return s;
}
function buildBookPage(b,hl){
  const s=document.createElement('section');s.className='page';
  const box=document.createElement('div');box.className='box click';
  box.innerHTML=`<h2>${hl?mark(b.title):b.title}</h2>
                 <p>${hl?mark(b.text):b.text}</p>
                 <p class="source">${b.book} â€” ${b.author}</p>`;
  if(b.url) box.onclick=()=>window.open(b.url,'_blank');
  s.appendChild(box);return s;
}
function buildNotePage(n,hl){
  const s=document.createElement('section');s.className='page';
  const box=document.createElement('div');box.className='box click';
  const host=n.url?new URL(n.url).hostname.replace(/^www\./,''):'';
  box.innerHTML=`<h2>${hl?mark(n.title):n.title}</h2>
                 <p class="source">${host}</p>`;
  if(n.url) box.onclick=()=>window.open(n.url,'_blank');
  s.appendChild(box);return s;
}

/* helpers */
function tagsOk(tags){return tagFilters.size?tags?.some(t=>tagFilters.has(t)):true;}
function mark(t){return t.replace(new RegExp(`(${query})`,'gi'),'<mark>$1</mark>');}
</script>
</body>
</html>