<!DOCTYPE html>
<html lang="it" id="root">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>futuro fortissimo ‚Äì explorer</title>

  <!-- Fonts & Tailwind -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Playfair+Display:ital@700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui']
          },
          colors: {
            bg: '#f6f9fe',
            acc: '#38bdf8'
          }
        }
      }
    }
  </script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{font-family:Inter,sans-serif;background:var(--tw-bg-opacity) bg;color:#111;overflow:hidden}
    mark{background:#38bdf8;color:#fff;padding:0 3px;border-radius:3px}
    .pill,.tag{background:#fff;padding:4px 13px;border-radius:9999px;cursor:pointer;user-select:none;transition:.2s}
    .pill{font-size:1.2rem}
    .pill.active{outline:2px solid #38bdf8}
    .tag{font-size:.85rem;margin-top:4px;margin-right:4px}
    #canvas{scroll-snap-type:y mandatory;overflow-y:auto;-webkit-overflow-scrolling:touch}
    .page{min-height:calc(100vh - 120px);scroll-snap-align:start;display:flex;align-items:center;padding-left:6vw}
    .box{width:calc(100% - 12vw);max-width:720px;max-height:78vh;overflow-y:auto;padding:2rem 1.7rem}
    .box::-webkit-scrollbar{display:none}
    .box h3{font-size:1.35rem;font-weight:700;margin-bottom:.4rem}
    .box p{font-size:1.15rem;line-height:1.6;margin-bottom:.65rem}
    .box.book h3{font-size:1.15rem}
    .src{font-size:.8rem;color:#555;margin-top:.3rem}

    /* ‚Äî‚Äî slightly larger fonts on desktop ‚Äî‚Äî */
    @media(min-width:1024px){
      .box h3{font-size:1.55rem}
      .box p{font-size:1.3rem}
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="fixed inset-x-0 top-0 h-[60px] px-[6vw] flex items-center justify-between z-30">
    <div class="flex items-center gap-2">
      <img src="logo.png" class="h-8">
      <h1 class="font-[Playfair_Display] italic text-[1.55rem]">futuro&nbsp;fortissimo</h1>
    </div>
    <div id="cta" class="flex items-center gap-4 text-[2rem]">
      <span id="ctaCoffee">‚òï</span><span id="ctaAbout">üë§</span>
      <span id="langBtn" class="cursor-pointer">üá¨üáß</span>
    </div>
  </header>

  <!-- SIDE EMOJI BAR -->
  <aside id="side" class="fixed top-[60px] bottom-[60px] right-0 w-[46px] flex flex-col items-center gap-2 pt-3 overflow-y-auto"></aside>

  <!-- CANVAS -->
  <main id="canvas" class="fixed top-[60px] bottom-[60px] right-[46px] left-0"></main>

  <!-- SEARCH -->
  <footer class="fixed inset-x-0 bottom-0 h-[60px] bg-bg flex items-center px-[6vw] gap-3">
    <input id="search" placeholder="cerca / search‚Ä¶" class="flex-1 rounded-full border-2 border-black px-4 py-2 text-lg outline-none">
    <button id="searchBtn" class="text-[1.8rem] text-acc">üîç</button>
  </footer>

<script>
/******************************
 *         CONSTANTS          *
 ******************************/
const PATH  = { it: 'newsletter_data.json', en: 'newsletter_data_en.json' },
      NOTES = 'notes.json',
      BOOKS = 'books.json',
      NOTE_TAG = 'üé∂'; // ‚Üê keep the original note tag!

/******************************
 *           STATE            *
 ******************************/
let PUBS, NOTESARR, BOOKSARR, LANG = 'it', q = '';
const selTags = new Set();

/******************************
 *          HELPERS           *
 ******************************/
const $     = s => document.querySelector(s),
      rnd   = a => [...a].sort(()=>Math.random()-0.5), // non‚Äëmutating shuffle
      match = t => t.includes(q),
      mark  = t => q ? t.replace(new RegExp(`(${q})`,'gi'),'<mark>$1</mark>') : t,
      pg    = c => { const p = document.createElement('section'); p.className='page'; p.appendChild(c); return p; },
      open  = url => window.open(url,'_blank');

/******************************
 *          UI SETUP          *
 ******************************/
const allTags = ['üìö', NOTE_TAG, 'üíª','üçÉ','‚ù§Ô∏è','üí∏','‚öΩ','üçΩ','üß†','üíä','üé®','üöï','ü•Ω','üë•','üíÜ'];
const side = $('#side');
allTags.forEach(tag=>{
  const el=document.createElement('div');
  el.textContent=tag;
  el.className='pill';
  el.onclick=()=>{
    el.classList.toggle('active');
    selTags.has(tag)?selTags.delete(tag):selTags.add(tag);
    render();
  };
  side.appendChild(el);
});

$('#ctaCoffee').onclick=()=>open('https://www.paypal.com/paypalme/michelemerelli');
$('#ctaAbout').onclick =()=>open('https://linktr.ee/micmer');
$('#langBtn').onclick   =()=>{
  LANG = LANG==='it'?'en':'it';
  $('#langBtn').textContent = LANG==='it'?'üá¨üáß':'üáÆüáπ';
  loadData();
};

const searchInput = $('#search');
searchInput.oninput =()=>{q=searchInput.value.trim().toLowerCase();render();};
$('#searchBtn').onclick =()=>{searchInput.blur();q=searchInput.value.trim().toLowerCase();render();};

/******************************
 *         DATA LOAD          *
 ******************************/
function loadData(){
  Promise.all([
    fetch(PATH[LANG]).then(r=>r.json()),
    fetch(NOTES).then(r=>r.json()),
    fetch(BOOKS).then(r=>r.json())
  ]).then(([pubData, noteData, bookData])=>{
    PUBS      = pubData.publications; // don't shuffle here - we'll shuffle per render
    NOTESARR  = noteData.notes.map(n=>({...n, tags: n.tags?.length?n.tags:[NOTE_TAG]}));
    BOOKSARR  = bookData.map(b=>({...b, tags: b.tags?.length?b.tags:['üìö']}));

    // reset filters/search UI
    selTags.clear();
    document.querySelectorAll('#side .pill.active').forEach(p=>p.classList.remove('active'));
    q='';
    searchInput.value='';

    render();
  });
}

/******************************
 *         CARD FACTORY       *
 ******************************/
function pubCard(pub, scheda, highlight){
  const c=document.createElement('div');
  c.className='box';
  c.style.background='#fff';
  c.innerHTML=`<h3>${highlight?mark(scheda.title):scheda.title}</h3>`+
              scheda.contentBlocks[0].content.map(l=>`<p>${highlight?mark(l):l}</p>`).join('');
  c.onclick=()=>open(pub.substackLink);
  return pg(c);
}
function bookCard(b, highlight){
  const c=document.createElement('div');
  c.className='box book';
  c.style.background='#fff';
  c.innerHTML=`<h3>${highlight?mark(b.title):b.title}</h3>`+
              `<p>${highlight?mark(b.text):b.text}</p>`+
              `<p class='src'>${b.book} ‚Äî ${b.author}</p>`;
  if(b.url) c.onclick=()=>open(b.url);
  return pg(c);
}
function noteCard(n, highlight){
  const host=n.url?new URL(n.url).hostname.replace(/^www\./,''):'';
  const c=document.createElement('div');
  c.className='box';
  c.style.background='#fff';
  c.innerHTML=`<h3>${highlight?mark(n.title):n.title}</h3>${host?`<p class='src'>${host}</p>`:''}`;
  if(n.url) c.onclick=()=>open(n.url);
  return pg(c);
}

/******************************
 *           RENDER           *
 ******************************/
function render(){
  const cv = $('#canvas');
  cv.innerHTML='';

  const hasFilter = selTags.size>0,
        hasQuery  = q.length>0;
  let stack=[];

  // ‚Äî‚Äî HOME (no filter, no search) ‚Äî‚Äî
  if(!hasFilter && !hasQuery){
    stack=[
      ...PUBS.flatMap(p=>p.cards.filter(c=>!c.title.startsWith('üìñ')).map(c=>pubCard(p,c,false))),
      ...BOOKSARR.map(b=>bookCard(b,false)),
      ...NOTESARR.map(n=>noteCard(n,false))
    ];
    // Shuffle and append all items
    rnd(stack).forEach(el=>cv.appendChild(el));
  }
  // ‚Äî‚Äî ONLY TAG FILTER ‚Äî‚Äî
  else if(hasFilter && !hasQuery){
    // Handle books filter
    if(selTags.has('üìö')){
      stack.push(...BOOKSARR.map(b=>bookCard(b,false)));
    }
    // Handle notes filter
    if(selTags.has(NOTE_TAG)){
      stack.push(...NOTESARR.map(n=>noteCard(n,false)));
    }
    // Handle publication cards with matching tags
    PUBS.forEach(p=>p.cards.filter(c=>!c.title.startsWith('üìñ') && c.tags?.some(t=>selTags.has(t))).forEach(c=>stack.push(pubCard(p,c,false))));
    
    // Shuffle and append filtered items
    rnd(stack).forEach(el=>cv.appendChild(el));
  }
  // ‚Äî‚Äî SEARCH (with/without tags) ‚Äî‚Äî
  else{
    PUBS.forEach(p=>p.cards.filter(c=>{
      const tagOk = !hasFilter || c.tags?.some(t=>selTags.has(t));
      const txtOk = match((c.title + c.contentBlocks[0].content.join(' ')).toLowerCase());
      return !c.title.startsWith('üìñ') && tagOk && txtOk;
    }).forEach(c=>stack.push(pubCard(p,c,true))));

    BOOKSARR.forEach(b=>{
      if((!hasFilter || selTags.has('üìö')) && match((b.title+b.text).toLowerCase())) stack.push(bookCard(b,true));
    });
    NOTESARR.forEach(n=>{
      if((!hasFilter || selTags.has(NOTE_TAG)) && match(n.title.toLowerCase())) stack.push(noteCard(n,true));
    });
    // Don't shuffle search results - keep them ordered by relevance
    stack.forEach(el=>cv.appendChild(el));
  }

  // ‚Äî‚Äî FALLBACK ‚Äî‚Äî
  if(stack.length===0){
    stack=[
      ...PUBS.flatMap(p=>p.cards.filter(c=>!c.title.startsWith('üìñ')).map(c=>pubCard(p,c,false))),
      ...BOOKSARR.map(b=>bookCard(b,false)),
      ...NOTESARR.map(n=>noteCard(n,false))
    ];
    rnd(stack).forEach(el=>cv.appendChild(el));
  }

  // always scroll top after render
  cv.scrollTo(0,0);
}

loadData();
</script>
</body>
</html>
