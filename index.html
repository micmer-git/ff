<!DOCTYPE html>
<html lang="it" id="roothtml">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>futuro fortissimo â€“ explorer</title>

  <!-- Google Sans -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily:{ sans:['"Google Sans"','Roboto','ui-sans-serif'] },
          colors:{ ioBg:'#F6F9FE' },
          boxShadow:{ neu:'4px 4px 8px rgba(0,0,0,.06)' }
        }
      }
    };
  </script>

  <style>
    body { background:#F6F9FE }
    .pill, .tag {
      background:#fff;
      box-shadow:0 1px 4px rgba(0,0,0,.1);
      padding:4px 12px;
      border-radius:9999px;
      user-select:none;
      transition:.15s;
    }
    .pill { cursor:pointer; font-size:1.1rem }
    .pill.active { outline:2px solid #38bdf8 }
    .hide-scrollbar::-webkit-scrollbar { display:none }
    .hide-scrollbar { -ms-overflow-style:none; scrollbar-width:none }
    .scroll-snap-x { scroll-snap-type:x mandatory }
    .snap-start { scroll-snap-align:start }
    .exp-card {
      transform:scale(.95);
      opacity:0;
      transition:transform .35s ease,opacity .35s ease
    }
    .exp-card.enter { transform:scale(1); opacity:1 }
    .exp-card.exit  { transform:scale(.9); opacity:0 }
    .expander {
      position:absolute; right:10px; bottom:10px;
      background:#fff; border-radius:9999px;
      padding:6px 9px; font-size:18px;
      box-shadow:0 1px 4px rgba(0,0,0,.15);
      cursor:pointer
    }
    .pub-sub { cursor:pointer }
  </style>
</head>

<body class="font-sans text-gray-800 antialiased text-[18px]">
<header class="py-2">
  <div class="max-w-3xl mx-auto flex items-center justify-center gap-3 px-4">
    <img src="logo.png" alt="logo Futuro Fortissimo" class="h-8" />
    <h1 class="italic lowercase text-3xl font-semibold">futuro fortissimo</h1>
  </div>
</header>

<section class="max-w-3xl mx-auto px-4 space-y-3">
  <div class="flex items-center gap-3">
    <div class="relative flex-grow">
      <input id="searchInput" placeholder="search / cercaâ€¦" class="w-full rounded-full py-2 pl-11 pr-4 bg-white shadow-neu focus:outline-none focus:ring-2 focus:ring-sky-400" />
      <span class="absolute left-4 top-1/2 -translate-y-1/2 text-lg">ğŸ”</span>
    </div>
    <!-- only ğŸ“š and ğŸ¶ pills now -->
    <div id="mainFilterRow" class="flex gap-2">
      <span class="pill" data-filter="ğŸ“š">ğŸ“š</span>
      <span class="pill" data-filter="ğŸ¶">ğŸ¶</span>
    </div>
  </div>
  <div id="tagFilterRow" class="flex flex-wrap justify-center gap-2 text-xl">
    <span class="pill" data-filter="ğŸ’»">ğŸ’»</span>
    <span class="pill" data-filter="ğŸƒ">ğŸƒ</span>
    <span class="pill" data-filter="â¤ï¸">â¤ï¸</span>
    <span class="pill" data-filter="ğŸ’¸">ğŸ’¸</span>
    <span class="pill" data-filter="âš½">âš½</span>
    <span class="pill" data-filter="ğŸ½">ğŸ½</span>
    <span class="pill" data-filter="ğŸ§ ">ğŸ§ </span>
    <span class="pill" data-filter="ğŸ’Š">ğŸ’Š</span>
    <span class="pill" data-filter="ğŸ¨">ğŸ¨</span>
    <span class="pill" data-filter="ğŸš•">ğŸš•</span>
    <span class="pill" data-filter="ğŸ¥½">ğŸ¥½</span>
    <span class="pill" data-filter="ğŸ‘¥">ğŸ‘¥</span>
    <span class="pill" data-filter="ğŸ’†">ğŸ’†</span>
  </div>
</section>

<main id="app" class="max-w-3xl mx-auto px-4 pb-32 space-y-6 mt-6"></main>

<footer class="fixed bottom-0 inset-x-0 flex items-center justify-center gap-3 py-2 text-base bg-ioBg/90 backdrop-blur">
  <button onclick="window.open('https://www.paypal.com/paypalme/michelemerelli','_blank')" class="pill">â˜• sostieni</button>
  <button onclick="window.open('https://linktr.ee/micmer','_blank')" class="pill">ğŸ‘¤ chi&nbsp;sono</button>
  <button id="langToggle" class="pill">ğŸ‡¬ğŸ‡§ english</button>
</footer>

<script>
let LANG='it';
const PATH={it:'newsletter_data.json',en:'newsletter_data_en.json'};
const NOTES_PATH='notes.json', BOOKS_PATH='books.json';
let DATA, NOTES, BOOKS;
const filters=new Set();
const gradients=[
  'linear-gradient(135deg,#38bdf8,#c084fc)',
  'linear-gradient(135deg,#f472b6,#facc15)',
  'linear-gradient(135deg,#34d399,#60a5fa)',
  'linear-gradient(135deg,#f87171,#fb923c)',
  'linear-gradient(135deg,#a78bfa,#f472b6)',
  'linear-gradient(135deg,#fb923c,#fde68a)',
  'linear-gradient(135deg,#5eead4,#3b82f6)',
  'linear-gradient(135deg,#fda4af,#c4b5fd)'
];

const $=s=>document.querySelector(s),
      match=(t,s)=>t.toLowerCase().includes(s),
      hl=(t,s)=>s?t.replace(new RegExp(`(${s})`,'gi'),'<mark>$1</mark>'):t;

$('#mainFilterRow').addEventListener('click',e=>{
  if(!e.target.dataset.filter) return;
  let f=e.target.dataset.filter;
  filters.has(f)?filters.delete(f):filters.add(f);
  e.target.classList.toggle('active');
  render();
});
$('#tagFilterRow').addEventListener('click',e=>{
  if(!e.target.dataset.filter) return;
  let f=e.target.dataset.filter;
  filters.has(f)?filters.delete(f):filters.add(f);
  e.target.classList.toggle('active');
  render();
});
$('#searchInput').oninput=render;
$('#langToggle').onclick=()=>{
  LANG=LANG==='it'?'en':'it';
  $('#langToggle').textContent=LANG==='it'?'ğŸ‡¬ğŸ‡§ english':'ğŸ‡®ğŸ‡¹ italiano';
  document.documentElement.lang=LANG;
  loadAll();
};

async function loadAll(){
  [DATA,NOTES,BOOKS]=await Promise.all([
    fetch(PATH[LANG]).then(r=>r.json()),
    fetch(NOTES_PATH).then(r=>r.json()),
    fetch(BOOKS_PATH).then(r=>r.json())
  ]);
  DATA.publications.sort(()=>Math.random()-0.5);
  BOOKS.sort(()=>Math.random()-0.5);
  NOTES.notes.sort(()=>Math.random()-0.5);

  filters.clear();
  document.querySelectorAll('.pill.active').forEach(p=>p.classList.remove('active'));
  $('#searchInput').value='';
  render();
}

function render(){
  const term=$('#searchInput').value.toLowerCase(),
        activeS=term.length>0,
        mainSel=[...filters].filter(f=>['ğŸ“š','ğŸ¶'].includes(f)),
        themeSel=[...filters].filter(f=>!['ğŸ“š','ğŸ¶'].includes(f));
  const wrap=$('#app'); wrap.innerHTML='';

  // search mode
  if(activeS){
    DATA.publications.forEach((pub,pi)=>{
      pub.cards.filter(c=>!c.title.startsWith('ğŸ“–')).forEach(c=>{
        let all=pub.title+' '+c.title+' '+c.contentBlocks[0].content.join(' ');
        if(match(all,term)){
          wrap.appendChild(makePubCard(pub,c,pi,term));
        }
      });
    });
    return;
  }

  // main-filter ğŸ“š
  if(mainSel.includes('ğŸ“š') && mainSel.length===1){
    wrap.appendChild(makeBooksList(BOOKS));
    return;
  }
  // main-filter ğŸ¶
  if(mainSel.includes('ğŸ¶') && mainSel.length===1){
    wrap.appendChild(makeNotesList(NOTES.notes));
    return;
  }

  // theme-filter only subchapters
  if(themeSel.length>0){
    DATA.publications.forEach((pub,pi)=>{
      pub.cards.filter(c=>!c.title.startsWith('ğŸ“–') && c.tags?.some(t=>themeSel.includes(t)))
        .forEach(c=>wrap.appendChild(makePubCard(pub,c,pi,'')));
    });
    return;
  }

  // default: strip + books + notes
  wrap.appendChild(makePubStrip(DATA.publications));
  wrap.appendChild(makeBooksStrip(BOOKS));
  wrap.appendChild(makeNotesStrip(NOTES.notes));
}

function makePubStrip(list){
  const d=document.createElement('div');
  d.className='flex gap-4 overflow-x-auto hide-scrollbar scroll-snap-x scroll-smooth pb-2';
  list.forEach((pub,i)=>{
    const card=document.createElement('div');
    card.className='relative rounded-xl flex-shrink-0 snap-start overflow-hidden cursor-pointer w-full max-w-[320px]';
    card.style.background=gradients[i%gradients.length]; card.style.padding='2px';
    const inr=document.createElement('div');
    inr.className='bg-white rounded-xl p-5 shadow-neu h-40 flex flex-col justify-center';
    inr.innerHTML=`<h3 class='font-semibold text-xl mb-2 text-center'>${pub.title}</h3>`;
    card.appendChild(inr);
    const btn=document.createElement('button');
    btn.className='expander'; btn.textContent='â¤¢';
    btn.onclick=e=>{ e.stopPropagation(); openExpanded(pub); };
    card.appendChild(btn);
    card.onclick=()=>openExpanded(pub);
    d.appendChild(card);
  });
  return d;
}

function makePubCard(pub,c,idx,term){
  const card=document.createElement('div');
  card.className='rounded-xl overflow-hidden mb-4';
  card.style.cssText=`background:${gradients[idx%gradients.length]};padding:2px`;
  const inr=document.createElement('div');
  inr.className='bg-white rounded-xl p-5 shadow-neu pub-sub';
  inr.innerHTML=`
    <h3 class='font-semibold mb-1'>${term?hl(c.title,term):c.title}</h3>
    ${c.contentBlocks[0].content.map(l=>`<p class='text-base'>${term?hl(l,term):l}</p>`).join('')}
    <div class='flex flex-wrap gap-1 mt-1'>${(c.tags||[]).map(t=>`<span class='tag'>${t}</span>`).join('')}</div>
  `;
  inr.onclick=()=>window.open(pub.substackLink,'_blank');
  card.appendChild(inr);
  return card;
}

function openExpanded(pub){
  document.querySelectorAll('.exp-card').forEach(c=>c.remove());
  $('#pubStrip')?.classList.add('hidden');
  const tagSel=[...filters].filter(f=>!['ğŸ“š','ğŸ¶'].includes(f));
  const subs=pub.cards.filter(c=>!c.title.startsWith('ğŸ“–'))
    .filter(c=>!tagSel.length||c.tags?.some(t=>tagSel.includes(t)));
  const idx=DATA.publications.findIndex(p=>p.title===pub.title);
  const cont=document.createElement('div');
  cont.className='exp-card rounded-xl overflow-hidden mb-4';
  cont.style.cssText=`background:${gradients[idx%gradients.length]};padding:2px`;
  const inr=document.createElement('div');
  inr.className='bg-white rounded-xl p-5 shadow-neu';
  subs.forEach(c=>{
    inr.innerHTML+=`
      <div class='pub-sub mb-4' onclick="window.open('${pub.substackLink}','_blank')">
        <h3 class='font-semibold mb-1'>${c.title}</h3>
        ${c.contentBlocks[0].content.map(l=>`<p class='text-base'>${l}</p>`).join('')}
      </div>`;
  });
  cont.appendChild(inr);

  const close=document.createElement('button');
  close.textContent='âœ•'; close.className='absolute top-2 right-2 text-2xl';
  close.onclick=()=>{
    cont.classList.remove('enter'); cont.classList.add('exit');
    setTimeout(()=>{
      cont.remove(); $('#pubStrip')?.classList.remove('hidden');
    },350);
  };
  cont.style.position='relative';
  cont.appendChild(close);

  document.querySelector('#app').prepend(cont);
  requestAnimationFrame(()=>cont.classList.add('enter'));
  cont.scrollIntoView({behavior:'smooth',block:'center'});
}

function makeBooksStrip(list){
  const d=document.createElement('div');
  d.className='flex gap-4 overflow-x-auto hide-scrollbar scroll-snap-x scroll-smooth pb-2';
  list.forEach(b=>{
    const card=document.createElement('div');
    card.className='rounded-xl border-2 border-indigo-500 flex-shrink-0 w-full max-w-[320px] snap-start';
    card.style.background='#fff';
    if(b.url) card.onclick=()=>window.open(b.url,'_blank');
    const inr=document.createElement('div');
    inr.className='p-5 flex flex-col justify-between min-h-[180px]';
    inr.innerHTML=`
      <h3 class='font-semibold text-lg mb-1'>${b.title}</h3>
      <p class='quote'>&ldquo;${b.text}&rdquo;</p>
      <p class='source mt-2'>${b.book} â€” ${b.author}</p>
    `;
    card.appendChild(inr);
    d.appendChild(card);
  });
  return d;
}

function makeBooksList(list){
  const c=document.createElement('div'); c.className='space-y-4';
  list.forEach(b=>{
    const card=document.createElement('div');
    card.className='rounded-xl border-2 border-indigo-500 p-4';
    card.style.background='#fff';
    if(b.url) card.onclick=()=>window.open(b.url,'_blank');
    card.innerHTML=`
      <h3 class='font-semibold text-lg mb-1'>${b.title}</h3>
      <p class='quote'>&ldquo;${b.text}&rdquo;</p>
      <p class='source mt-2'>${b.book} â€” ${b.author}</p>
    `;
    c.appendChild(card);
  });
  return c;
}

function makeNotesStrip(list){
  const d=document.createElement('div');
  d.className='flex gap-4 overflow-x-auto hide-scrollbar scroll-snap-x scroll-smooth pb-2';
  list.forEach(n=>{
    const card=document.createElement('div');
    card.className='rounded-xl border-2 border-black flex-shrink-0 w-full max-w-[320px] snap-start';
    card.style.background='#fff';
    if(n.url) card.onclick=()=>window.open(n.url,'_blank');
    const inr=document.createElement('div');
    inr.className='p-5 flex flex-col justify-between min-h-[160px]';
    inr.innerHTML=`
      <h3 class='font-semibold mb-1'>${n.title}</h3>
      <div class='flex flex-wrap gap-1'>${n.tags.map(t=>`<span class='tag'>${t}</span>`).join('')}</div>
      <p class='source mt-2'>${new URL(n.url).hostname.replace(/^www\./,'')}</p>
    `;
    card.appendChild(inr);
    d.appendChild(card);
  });
  return d;
}

function makeNotesList(list){
  const c=document.createElement('div'); c.className='space-y-4';
  list.forEach(n=>{
    const card=document.createElement('div');
    card.className='rounded-xl border-2 border-black p-4';
    card.style.background='#fff';
    if(n.url) card.onclick=()=>window.open(n.url,'_blank');
    card.innerHTML=`
      <h3 class='font-semibold mb-1'>${n.title}</h3>
      <div class='flex flex-wrap gap-1'>${n.tags.map(t=>`<span class='tag'>${t}</span>`).join('')}</div>
      <p class='source mt-2'>${new URL(n.url).hostname.replace(/^www\./,'')}</p>
    `;
    c.appendChild(card);
  });
  return c;
}

// kick off
loadAll();
</script>
</body>
</html>