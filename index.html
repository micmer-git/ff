<!DOCTYPE html>
<html lang="it" id="roothtml">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>futuro fortissimo – explorer</title>

  <!-- Google Sans -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Tailwind (CDN build) -->
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['"Google Sans"', 'Roboto', 'ui-sans-serif'] },
          colors:     { ioBg:  '#F6F9FE' },
          boxShadow:  { neu:   '4px 4px 8px rgba(0,0,0,.06)' }
        }
      }
    };
  </script>

  <style>
    body { background: #F6F9FE; }
    mark { background: #FFEB3B66; padding: 0 2px; border-radius: 3px; }
    .pill, .tag {
      background: #fff;
      box-shadow: 0 1px 4px rgba(0,0,0,.1);
      padding: 4px 12px;
      border-radius: 9999px;
      user-select: none;
      transition: .15s;
    }
    .pill { cursor: pointer; font-size: 1.1rem; }
    .pill.active { outline: 2px solid #38bdf8; }
    .hide-scrollbar::-webkit-scrollbar { display: none }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none }
    .scroll-snap-x { scroll-snap-type: x mandatory }
    .snap-start { scroll-snap-align: start }

    /* card open / close animation */
    .exp-card { transform: scale(.95); opacity:0; transition: transform .35s ease, opacity .35s ease }
    .exp-card.enter { transform: scale(1); opacity:1 }
    .exp-card.exit  { transform: scale(.9); opacity:0 }
    .expander { position:absolute; right:10px; bottom:10px; background:#fff; border-radius:9999px; padding:6px 9px; font-size:18px; box-shadow:0 1px 4px rgba(0,0,0,.15); cursor:pointer }

    /* book/notes card text slightly smaller and wrapping */
    .book-card p, .note-card h3 { word-break: break-word; }
    .book-card p.quote { font-size: 1rem; }      /* about 16px */
    .book-card p.source { font-size: .875rem; } /* about 14px */

  </style>
</head>

<body class="font-sans text-gray-800 antialiased text-[18px]">
<header class="py-2">
  <div class="max-w-3xl mx-auto flex items-center justify-center gap-3 px-4">
    <img src="logo.png" alt="logo Futuro Fortissimo" class="h-8" />
    <h1 class="italic lowercase text-3xl font-semibold">futuro fortissimo</h1>
  </div>
</header>

<section class="max-w-3xl mx-auto px-4 space-y-3">
  <!-- Search + main filters -->
  <div class="flex items-center gap-3">
    <div class="relative flex-grow">
      <input id="searchInput" placeholder="search / cerca…" class="w-full rounded-full py-2 pl-11 pr-4 bg-white shadow-neu focus:outline-none focus:ring-2 focus:ring-sky-400" />
      <span class="absolute left-4 top-1/2 -translate-y-1/2 text-lg">🔍</span>
    </div>
    <div id="mainFilterRow" class="flex gap-2">
      <span class="pill" data-filter="🎼">🎼</span>
      <span class="pill" data-filter="📚">📚</span>
      <span class="pill" data-filter="🎶">🎶</span>
    </div>
  </div>

  <!-- Tag filters -->
  <div id="tagFilterRow" class="flex flex-wrap justify-center gap-2 text-xl">
    <span class="pill" data-filter="💻">💻</span>
    <span class="pill" data-filter="🍃">🍃</span>
    <span class="pill" data-filter="❤️">❤️</span>
    <span class="pill" data-filter="💸">💸</span>
    <span class="pill" data-filter="⚽">⚽</span>
    <span class="pill" data-filter="🍽">🍽</span>
    <span class="pill" data-filter="🧠">🧠</span>
    <span class="pill" data-filter="💊">💊</span>
    <span class="pill" data-filter="🎨">🎨</span>
    <span class="pill" data-filter="🚕">🚕</span>
    <span class="pill" data-filter="🥽">🥽</span>
    <span class="pill" data-filter="👥">👥</span>
    <span class="pill" data-filter="💆">💆</span>
  </div>
</section>

<main id="app" class="max-w-3xl mx-auto px-4 pb-32 space-y-6 mt-6"></main>

<footer class="fixed bottom-0 inset-x-0 flex items-center justify-center gap-3 py-2 text-base bg-ioBg/90 backdrop-blur">
  <button onclick="window.open('https://www.paypal.com/paypalme/michelemerelli','_blank')" class="pill">☕ sostieni</button>
  <button onclick="window.open('https://linktr.ee/micmer','_blank')" class="pill">👤 chi&nbsp;sono</button>
  <button id="langToggle" class="pill">🇬🇧 english</button>
</footer>

<script>
/* ---------- paths & globals ---------- */
let LANG = 'it';
const PATH = { it:'newsletter_data.json', en:'newsletter_data_en.json' };
const NOTES_PATH = 'notes.json';
const BOOKS_PATH = 'books.json';

let DATA, NOTES, BOOKS;
const filters = new Set();
const gradients = [
  'linear-gradient(135deg,#38bdf8,#c084fc)',
  'linear-gradient(135deg,#f472b6,#facc15)',
  'linear-gradient(135deg,#34d399,#60a5fa)',
  'linear-gradient(135deg,#f87171,#fb923c)',
  'linear-gradient(135deg,#a78bfa,#f472b6)',
  'linear-gradient(135deg,#fb923c,#fde68a)',
  'linear-gradient(135deg,#5eead4,#3b82f6)',
  'linear-gradient(135deg,#fda4af,#c4b5fd)'
];

/* ---------- helpers ---------- */
const match = (txt,term) => txt.toLowerCase().includes(term);
const hl = (txt,term) => term ? txt.replace(new RegExp(`(${term})`,'gi'),'<mark>$1</mark>') : txt;
const $ = s => document.querySelector(s);

/* ---------- listeners ---------- */
$('#mainFilterRow').addEventListener('click', e => {
  if (!e.target.dataset.filter) return;
  const f = e.target.dataset.filter;
  filters.has(f) ? filters.delete(f) : filters.add(f);
  e.target.classList.toggle('active');
  render();
});
$('#tagFilterRow').addEventListener('click', e => {
  if (!e.target.dataset.filter) return;
  const f = e.target.dataset.filter;
  filters.has(f) ? filters.delete(f) : filters.add(f);
  e.target.classList.toggle('active');
  render();
});
$('#searchInput').oninput = render;
$('#langToggle').onclick = () => {
  LANG = LANG==='it' ? 'en' : 'it';
  $('#langToggle').textContent = LANG==='it' ? '🇬🇧 english' : '🇮🇹 italiano';
  document.documentElement.lang = LANG;
  loadAll();
};

/* ---------- load JSON ---------- */
async function loadAll(){
  [DATA, NOTES, BOOKS] = await Promise.all([
    fetch(PATH[LANG]).then(r=>r.json()),
    fetch(NOTES_PATH).then(r=>r.json()),
    fetch(BOOKS_PATH).then(r=>r.json())
  ]);

  // shuffle each section
  DATA.publications.sort(()=>Math.random()-0.5);
  BOOKS.sort(()=>Math.random()-0.5);
  if (Array.isArray(NOTES.notes)) NOTES.notes.sort(()=>Math.random()-0.5);

  filters.clear();
  document.querySelectorAll('.pill.active').forEach(p=>p.classList.remove('active'));
  $('#searchInput').value = '';
  render();
}

/* ---------- render ---------- */
function render(){
  const term = $('#searchInput').value.toLowerCase();
  const activeS = term.length>0;
  const activeF = filters.size>0;

  const wrap = $('#app'); wrap.innerHTML = '';

  // defaults: pubs → books → notes
  if (!activeS && !activeF){
    wrap.appendChild(makePubStrip(DATA.publications));
    wrap.appendChild(makeBooksStrip(BOOKS,false,term));
    wrap.appendChild(makeNotesStrip(NOTES.notes,false,term));
    return;
  }

  // search / filter branch
  // Publications
  const pubVis = DATA.publications.filter(pub=>{
    // if any tag filter (tag emojis) -> check cards tags
    const isTagFilter = [...filters].some(f=>'💻🍃❤️💸⚽🍽🧠💊🎨🚕🥽👥💆'.includes(f));
    if (isTagFilter){
      return pub.cards.some(c=>c.tags?.some(t=>filters.has(t)));
    }
    // if search, match title or any line
    if (activeS){
      return pub.title.toLowerCase().includes(term)
        || pub.cards.some(c=>c.title.toLowerCase().includes(term)
          || c.contentBlocks.some(b=>b.content.some(l=>l.toLowerCase().includes(term))));
    }
    // if main filter 🎼 only
    if (filters.has('🎼')) return true;
    return false;
  });
  if(pubVis.length) wrap.appendChild(makePubCards(pubVis,term));

  // Books
  const bookVis = BOOKS.filter(b=>{
    if (filters.has('📚') && !activeS) return true;
    if (activeS){
      return b.title.toLowerCase().includes(term)
        || b.text.toLowerCase().includes(term)
        || b.book.toLowerCase().includes(term)
        || b.author.toLowerCase().includes(term);
    }
    return filters.size===0;
  });
  if(bookVis.length) wrap.appendChild(makeBooksStrip(bookVis,true,term));

  // Notes
  const noteVis = (NOTES.notes||[]).filter(n=>{
    if (filters.has('🎶') && !activeS) return true;
    if (activeS){
      return n.title.toLowerCase().includes(term)
        || (n.description||'').toLowerCase().includes(term);
    }
    return filters.size===0;
  });
  if(noteVis.length) wrap.appendChild(makeNotesStrip(noteVis,true,term));
}

/* ---------- components ---------- */
function makePubStrip(list){
  const strip = document.createElement('div');
  strip.className = 'flex gap-4 overflow-x-auto hide-scrollbar scroll-snap-x scroll-smooth pb-2';
  list.forEach((pub,i)=>{
    const card = document.createElement('div');
    card.className = 'relative rounded-xl flex-shrink-0 snap-start overflow-hidden cursor-pointer w-full max-w-[320px]';
    card.style.background = gradients[i%gradients.length];
    card.style.padding = '2px';

    const inr = document.createElement('div');
    inr.className = 'bg-white rounded-xl p-5 shadow-neu h-40 flex flex-col justify-center';
    const pano = pub.cards.find(c=>c.title.startsWith('📖'));
    inr.innerHTML = `<h3 class='font-semibold text-xl mb-2 text-center break-words'>${pub.title}</h3>` +
                    (pano?`<p class='text-base text-center break-words'>${pano.contentBlocks[0].content[0]}</p>`:'');
    card.appendChild(inr);

    const btn = document.createElement('button');
    btn.className='expander'; btn.textContent='⤢';
    btn.onclick = e=>{ e.stopPropagation(); openExpanded(pub); };
    card.appendChild(btn);

    card.onclick = ()=>openExpanded(pub);
    strip.appendChild(card);
  });
  return strip;
}

function makePubCards(list,term){
  const container = document.createElement('div');
  list.forEach((pub,idx)=>{
    pub.cards.filter(c=>!c.title.startsWith('📖')).forEach((c,i)=>{
      const card = document.createElement('div');
      card.className='rounded-xl overflow-hidden mb-4';
      card.style.cssText = `background:${gradients[idx%gradients.length]};padding:2px`;
      const inner = document.createElement('div');
      inner.className='bg-white rounded-xl p-5 shadow-neu';
      inner.innerHTML = `
        <h3 class='font-semibold mb-1'>${hl(c.title,term)}</h3>
        ${c.contentBlocks[0].content.map(l=>`<p class='text-base'>${hl(l,term)}</p>`).join('')}
        <div class='flex flex-wrap gap-1 mt-1'>${(c.tags||[]).map(t=>`<span class='tag'>${t}</span>`).join('')}</div>
      `;
      inner.onclick = ()=>window.open(pub.substackLink,'_blank');
      card.appendChild(inner);
      container.appendChild(card);
    });
  });
  return container;
}

function makeBooksStrip(list,showHeader,term){
  const strip = document.createElement('div');
  strip.className = 'flex gap-4 overflow-x-auto hide-scrollbar scroll-snap-x scroll-smooth pb-2';
  list.forEach(b=>{
    const card = document.createElement('div');
    card.className='book-card rounded-xl border-2 border-indigo-500 flex-shrink-0 w-full max-w-[320px] snap-start overflow-hidden';
    card.style.background='#ffffff';
    card.onclick = ()=>b.url && window.open(b.url,'_blank');

    const inner = document.createElement('div');
    inner.className='p-5 flex flex-col justify-between min-h-[180px]';
    inner.innerHTML = `
      <p class='quote text-lg break-words'>&ldquo;${hl(b.text,term)}&rdquo;</p>
      <p class='source text-sm text-gray-600 mt-2 break-words'>${hl(b.book,term)} — ${hl(b.author,term)}</p>
    `;
    card.appendChild(inner);
    strip.appendChild(card);
  });
  return strip;
}

function makeNotesStrip(list,showHeader,term){
  const strip = document.createElement('div');
  strip.className = 'flex gap-4 overflow-x-auto hide-scrollbar scroll-snap-x scroll-smooth pb-2';
  list.forEach(n=>{
    const card = document.createElement('div');
    card.className='note-card rounded-xl border-2 border-black flex-shrink-0 w-full max-w-[320px] snap-start overflow-hidden';
    card.style.background='#ffffff';
    card.onclick = ()=>n.url && window.open(n.url,'_blank');

    const inner = document.createElement('div');
    inner.className='p-5 flex flex-col justify-between min-h-[160px]';
    inner.innerHTML = `
      <h3 class='font-semibold mb-1 text-base break-words'>${hl(n.title,term)}</h3>
      <p class='text-sm break-words'>${hl(n.description||'',term)}</p>
    `;
    card.appendChild(inner);
    strip.appendChild(card);
  });
  return strip;
}

/* ---------- start ---------- */
loadAll();
</script>
</body>
</html>